# Bunin Every Dat bot

## Описание проекта
Данный репозиторий –– бот в телеграме, который подбирает строчку Бунина, рифмующуюся со строчкой пользователя. У него также есть несколько дополнительных функций

- изменение списка частей речи, на которые можно рифмовать (например, если убрать "глагол" из этого списка, бот не будет выдавать пользователю строчки Бунина, оканчивающиеся глаголом)
- функция подбора другой рифмы по тому же запросу
- статистика по пользователям
- проверка строки пользователя на сходство со строчками Бунина (на основе ML)

Бота можно найти по [ссылке](https://t.me/BuninEveryDayBot) или по тегу @BuninEveryDayBot

## Описание принципа работы

### Подбор рифмы:
1. С [сайта](https://t.me/BuninEveryDayBot) были скраулерены все тексты Бунина, и разбиты на строчки. Затем для каждой строчки определяется последнее слово и его часть речи. Весь этот код и его результаты находятся в папке parcing.
2. После получения запроса от пользователя бот краулерит рифмы к последнему слову запроса с [сайта](https://t.me/BuninEveryDayBot) (как точные рифмы, так и неточные, в разных падежах и числах). Для каждого полученного слова бот проверяет, нет ли строчки, заканчивающейся таким словом в датафрейме со строчками Бунина. Получается датафрейм с рифмующимися строчками.
3. Бот выдает пользователю одну строчку, затем по кнопке продолжает выдавать строчки из датафрейма до нажатия кнопки "Взять эту рифму" (или пока строчки не кончатся)

### Проверка строчки на сходство со строчкой Бунина
1. Как и для подбора рифмы, были получены строчки Бунина и столько же строчек случайных поэтов
2. На получившихся датафреймах была обучена линейная регрессия (TF IDF векторайзер). Модель обучалась на строчках. а не на текстах стихотворений, потому что то, как Бунин делит предложения на строчки и какой они длины, - тоже признак Бунина. Метрики удручающие - около 63%, но я перепробовала все комбинации классификаторов и векторайзеров, и это был лучший.
3. При получении запроса от пользователя бот классифицирует его строчку с помощью линейной регрессии и выдает результат "Похоже" / "Не похоже"

### Общие принципы:
- информация по юзерам (в т.ч. список допустимых частей речи и информация для статистики) хранится в словаре
- в боте используются состояния: бот начинает работу в состоянии start (чтобы он не сломался от пустого словаря с юзерами), работает в меню и с кнопками изменения допустимых частей речи в состоянии main, рифмует сообщения пользователя в состояниях rhyme, отдает строчку модели в состоянии model
- пользователь может сказать боту подобрать другую рифму, если выданная ему не понравилась. Для этого используются коллбэки. Они же используются для инлайн кнопок в меню и инлайн кнопок с изменяемым текстом в разделе с частями речи
- С помощью коллбэков бот умеет исправлять свои сообщения: переписка не засорена. С помощью исправляения сообщений также избегается наложение двух поисков рифмы одновременно - инлайн кнопки на первом ответе на запрос пропадают
   

## Структура репозитория
- **bot.py** –– файл с основным кодом

- **classifier.py** –– файл с кодом обучения модели

- **rhymes.py** –– файл с кодом, который подбирает рифму к слову  

- **** –– файл с собранными новостями

- **feedback.txt** –– файл с отзывами на сайт

- **error.txt** –– файл для сохранения ошибок, возникших во время работы краулера

- **meta.txt** –– файл для сохранения статистических данных по текстам

- **parcing** –– папка с кодом, который парсит строчки Бунина и других поэтов, и результатами этого кода
    - **base.html** –– шаблон для всех страниц

    - **main.html** –– главная страница

    - **stats.html**  –– страница со собранной статистикой

    - **feedback.html** –– страница для сбора отзывов на сайт

    - **gratitude_feedback.html** – страница с благодарностью за отзыв

    - **error.html** - страница для перенаправление в случае появления каких-то ошибок

- директория **static** –– папка, в которой хранятся изображения графиков

## Установка

Для корректной работы необходимо установить следующие модули:

```bash
pip3 install flask
pip3 install flask_apscheduler
pip3 install pandas
pip3 install matplotlib
pip3 install wordcloud
pip3 install requests
pip3 install bs4
pip3 install nltk
pip3 install pymystem3
pip3 install pymorphy2
pip3 install numpy
pip3 install torch
pip3 install transformers
```
